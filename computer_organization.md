# character 4 指令系统
* 计算机的指令有微指令、机器指令和伪指令之分，微指令属于硬件范畴，伪指令属于软件范畴，机器指令介于两者之间，一般是指机器指令。
* ISA:指令集体系结构
* “冯诺伊曼结构计算机“的思想，计算机的程序一旦被启动运行，则必须能够自动地逐条从主存取出指令执行
* 一条指令中必须明确的包含的信息：
    * 操作码，指定操作的类型
    * 源操作数或其地址，指出一个或多个源操作数或其所在的地址，可以是主存地址、寄存器编号、I／O端口，也可以是指令中直接给出一个立即数
    * 结果的地址，记过所存放的地址，可以是主存地址、寄存器编号、I/O端口
    * 下一条指令地址，下一条指令存放的地址，可以是主存地址
* 常用的寻址地址
    * 立即寻址，在指令中直接给出操作数本身，这种操作数称为立即数
    * 直接寻址，指令中给出的地址码是操作数的有效地址，这种地址称为直接地址或绝对地址
    * 间接寻址，指令中给出的地址码是存放操作数有效地址的主存单元地址
    * 寄存器间接寻址，指令中给出的地址码是一个寄存器编号，该寄存器中存放的是操作数的有效地址
    * 变址寻址，主要用于对线性表之类的数组元素进行方便的访问
    * 相对寻址
    * 基址寻址
* 移位指令：
    * 算术左移：操作数的各位依次向左移动，低位补零
    * 算术右移：各位依次向右移动，高位补符号位。
    * 逻辑左移：同算术左移
    * 逻辑右移：各位依次向右移，高位补零
* 常用的标志信息
    * 零标志 ZF
    * 溢出标志 OF
    * 符号标志 SF
    * 进位／借位标志 CF
* X-Y = X + Y' + 1 在运算器中减法的操作
* 目前，通用寄存器型指令占据主导地位，主要因为：
    * 通用寄存器和处理器集成在一起，作为ALU的操作数来源，可以缩短传输延迟。
    * 寄存器位于存储器层次化结构的顶端，速度快且容易使用。
* 汇编语言是与机器语言一一对应的符号化表示语言
* MIPS是32位鼎昌指令字，操作码字段也是固定长度。
* MIPS指令格式只有3种：
    * R型指令         
    OP(31-26)rs(25-21)rt(20-16)rd(15-11)shamt(10-6)func(5-0)
    * I型指令

        OP(31-26)rs(25-21)rt(20-16)立即数(15-0)
    * J型指令

        OP(31-26)直接地址(25-0)
        
* R型指令是RR型指令，其操作码OP为000000，操作类型由func字段指定，若是双目运算类指令，则rs和rt的内容分别作为第一和第二源操作数，结果送rd；若是移位指令，则对rt的内容进行移位，结果送rd，所移位数由shamt字段给出
* I型指令是立即数型指令，若是双目运算类指令，则将rs的内容和立即数分别作为第一和第二源操作数，结果送rt，若为load/store指令，则将rs和立即数符号扩展后的内容相加作为内存单元地址,Load指令将内存单元内容送rt，store指令会将rt内容送内存单元，如果是跳转指令的话，会根据rs，rt的内容来判断是否要进行跳转 * J型指令主要是无条件跳转指令，将当前的pc的高4位拼上26位直接地址，最后添2个0就可以得到32位的跳转目标方式。

# character 5 中央处理器
* 专门用来执行指令的部件就是中央处理器(CPU)
* 在CPU种控制指令执行的部件是控制器
* 指令按照顺序存放在内存连续单元中，指令地址由PC给出。
* 指令周期：CPU取出并执行一条指令的时间称为指令周期
* 指令执行过程：
    * 取指令并计算下一条指令地址
    * 对指令操作码译码
    * 计算源操作数地址并取源操作数
    * 数据操作
    * 目的操作数地址计算并存结果

    上述过程的前两步所有的指令都一样，对于后3步，完全由第二步译码得到的控制信号控制。

* 寄存器传送语言(RTL) 规定如下：
    * 用R[r]表示寄存器堆中寄存器r的内容
    * 用M[addr]表示读取存储单元addr的内容
    * 传送方向用<-表示，传送源在右，传送目的在左
    * 程序计数器PC直接用PC表示其内容
* 通常将指令执行过程中数据经过的路径，包括路径上的部件称为数据通路
* 数据通路中专门进行数据运算的部件称为执行部件，数据通路由控制部件进行控制
* 程序计数器，用来存放指令的地址
* 指令寄存器，用来存放现行指令
* 指令译码器，对指令寄存器中的操作码部分进行部分解析，产生对应的译码信号提供给操作控制信号形成部件
* 脉冲源及启停控制信号，脉冲源产生一定频率的脉冲信号作为整个机器的始终脉冲，是CPU时序的基准信号。启停线路需要时能够保证可靠地开放和封锁时钟信号
* 时序信号产生部件，以时钟脉冲为基础，产生不同指令对应的周期、节拍、工作脉冲等时许信号
* `beq rs,rt,imm16`做减法以比较rs和rt中内容的大小，并计算下一条指令地址，然后根据比较结果修改PC，转移目标地址采用相对寻址，基准地址为下一条指令地址(PC+4)，位移量为立即数imm16经符号扩展后的值的4倍
* 控制器分成主控制器和局部ALU控制器两部分。主控制器的输入为指令操作码op，输出各种控制信号，并根据指令所设计的ALU运算类型产生ALUop，同时生成一个R-型指令的控制信号R-type，用来控制选择将ALUop输出作为ALUctr信号，还是根据R-型指令中的func字段来产生ALUctr信号。因此，R-型指令时R-type==1,非R-型指令时R-type==0;
* 计算机性能由3个关键性因素决定：指令数目、时钟周期、CPI。指令数目由编译器和指令集所决定的，时钟周期和CPI由处理器的设计与实现决定
* CPU会遇到一些特殊情况而无法继续执行当前程序，主要分为两大类：
    * 内部异常，是指由处理器内部异常引起的意外事件
        * 故障，也称为失效，在引起故障的指令启动后、执行结束前被检测到的一类异常事件
        * 自陷，也称为陷进或陷入，与故障等其他意外发生的异常事件不同，这是预先安排的一种“异常”事件，首先通过某种方式将CPU设定为处于某个特定状态在程序执行过程中，一旦某条指令的执行发生了相应状态所满足的条件，则CPU调出特定的程序进行相应的处理
        * 终止，如果在执行指令过程中发生了使机器无法继续执行的硬件故，线路故障、断电等，则程序无法继续执行，只好终止。
        
    * 外部中断，程序执行过程中，若外设完成任务或发生某些特殊事件，会向CPU发中断请求，要求CPU对这些情况进行处理。通常，每条指令结束后，CPU都会主动去查询是否有终端请求，有的话，则将下一条指令地址作为断点保存，然后转到相应的中断服务程序执行，结束后再回到断点继续执行
    
* 异常处理过程：
    * 保护端点和程序状态
    * 识别异常事件并转异常处理

# character 6 指令流水线
上章中单周期处理器的指令执行都是采用串行方式。串行方式下，CPU总是在执行完一条指令后才取出下一条指令执行。这种串行方式并没有充分利用执行部件的并行性，所以指令的执行效率低。为了提高执行效率，可以采用流水线额方式，让多条指令的执行相互重叠起来。

* 一条指令流水线有以下5个流水段组成
    * 取指令(IF) 从cache或主存中取指令
    * 指令译码(ID) 产生指令执行所需的控制信号
    * 取操作数(OF) 读取存储器中操作数或寄存器操作数
    * 执行(EX) 对操作数完成指定操作
    * 写回(WB) 将操作数写回存储器或寄存器

* 流水线设计的原则，指令流水段个数以最复杂指令所用的功能段个数为准，流水段的长度以最复杂的操作所花时间为准。若流水段数为M，每个流水段的执行时间为T，则N条指令的执行总时间为(M+N-1)*T
* 适合流水线的指令集特征
    * 指令长度应尽量一致
    * 指令格式应尽量规整
    * 采用装入／存储型指令风格，可以保证除了Load/Store指令外的其他指令都不访问存储器

